{
  "taskGroups":[{
    "task_spec":{
      "runnables":[
        {
          "script": {
            "text": "nvidia-smi --query-gpu=uuid,serial --format=csv | awk -v host=`hostname` 'NR>1{print host,$0}'"
          }
        },
        { "barrier": {} },
        {
          "container": {
            "imageUri": "<TAG>",
            "entrypoint": "/bin/bash",
            "commands": ["-c", "mkdir -p /run/sshd; /usr/sbin/sshd -p 4000 -D"],
            "options": "--volume /etc:/etc --network host"
          },
          "background": true
        },
        {"barrier": {}},
        {
          "container": {
            "imageUri": "<TAG>",
            "entrypoint": "/bin/bash",
            "commands": ["-c", "if [ ${BATCH_TASK_INDEX} = 0 ]; then mpirun.openmpi -n ${BATCH_TASK_COUNT} --hostfile ${BATCH_HOSTS_FILE} /opt/run.sh; fi"],
            "options": "--gpus all --volume /etc:/etc --network host"
          },
          "environment": {"variables": {"OMPI_MCA_plm_rsh_args": "-p 4000", "OMPI_ALLOW_RUN_AS_ROOT": "1", "OMPI_ALLOW_RUN_AS_ROOT_CONFIRM": "1", "CUDA_VISIBLE_DEVICES": "0"}}
        },
        {"barrier": {}}
      ]
    },
    "task_count":5,
    "task_count_per_node": 1,
    "require_hosts_file": true,
    "permissive_ssh": true
  }],
  "logs_policy": {"destination": "CLOUD_LOGGING"},
  "allocationPolicy": {
    "instances": [{"installGpuDrivers": true, "policy": {"accelerators": [{"type": "nvidia-l4", "count": 1}], "bootDisk": {"image": "batch-debian"}}}]
  }
}